<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zhiyou100.video.mapper.VideoMapper">
    <cache/>
    <resultMap id="videoMap" type="Video">
        <id property="id" column="id"/>
        <result property="videoTitle" column="video_title"/>
        <result property="speakerId" column="speaker_id"/>
        <result property="courseId" column="course_id"/>
        <result property="videoLength" column="video_length"/>
        <result property="videoImageUrl" column="video_image_url"/>
        <result property="videoUrl" column="video_url"/>
        <result property="videoDesc" column="video_desc"/>
        <result property="insertTime" column="insert_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="videoPlayTimes" column="video_play_times"/>
        <association property="speaker" javaType="speaker">
            <id property="id" column="id"/>
            <result property="speakerName" column="speaker_name"/>
            <result property="speakerJob" column="speaker_job"/>
            <result property="speakerHeadUrl" column="speaker_head_url"/>
            <result property="speakerDesc" column="speaker_desc"/>
            <result property="insertTime" column="insert_time"/>
            <result property="updateTime" column="update_time"/>
        </association>
        <association property="course" javaType="course">
            <id property="id" column="id"/>
            <result property="courseName" column="course_name"/>
            <result property="courseDesc" column="course_desc"/>
            <result property="insertTime" column="insert_time"/>
            <result property="updateTime" column="update_time"/>
            <result property="subjectId" column="subject_id"/>
        </association>
    </resultMap>

    <sql id="selectAll" >
         select  * from  video,course,speaker where video.speaker_id = speaker.id and video.course_id = course.id
    </sql>

    <insert id="addVideo">
        insert into video(video_title,speaker_id,course_id,video_length,video_image_url,video_url,video_desc,insert_time,video_play_times)
         values (#{videoTitle},#{speakerId},#{courseId},#{videoLength},#{videoImageUrl},#{videoUrl},#{videoDesc},#{insertTime},#{videoPlayTimes})
    </insert>

    <update id="updateVideo">
        update video set video_title = #{videoTitle},speaker_id = #{speakerId},course_id =#{courseId},video_length=#{videoLength},
        video_image_url=#{videoImageUrl},video_url=#{videoUrl},video_desc=#{videoDesc},update_time=#{updateTime},video_play_times=#{videoPlayTimes} where id = #{id}
    </update>
    <delete id="deleteVideo">
        delete from video where id = #{id}
    </delete>
    <select id="queryAllVideo" resultMap="videoMap">
        select video.id,video_title,video_desc,speaker_name,course_name,video_length,video_play_times from  video,course,speaker where video.speaker_id = speaker.id and video.course_id = course.id
    </select>
    <select id="queryVideo" resultMap="videoMap">
        select video.id,video_title,video_desc,speaker_name,course_name,video_length,video_play_times from  video,course,speaker where video.speaker_id = speaker.id and video.course_id = course.id
        <where>
            <if test="videoTitle != '' and videoTitle != null">
                video_title like '%' #{videoTitle} '%'
            </if>
            <if test="speakerId != '' and speakerId != null">
                and speaker_id = #{speakerId}
            </if>
            <if test="courseId != '' and courseId != null">
                and course_id = #{courseId}
            </if>
        </where>

    </select>
    <select id="queryVideoById" resultMap="videoMap">
        select * from video where id = #{id}
    </select>
    <select id="queryAllVideos" resultMap="videoMap" parameterType="java.util.HashMap" >
         select  * from  video,course,speaker where video.speaker_id = speaker.id and video.course_id = course.id
        <if test="videoTitle!=null and videoTitle != '' ">
            and video_title like '%' #{videoTitle} '%'
        </if>
        <if test="speakerId != null and speakerId != ''">
            and speaker_id = #{speakerId}
        </if>
        <if test="courseId != null and courseId != ''">
            and course_id = #{courseId}
        </if>
        <if test="startIndex !=null">
            limit #{startIndex},#{pageSize}
        </if>
    </select>
    <select id="queryVideoTotal" resultType="java.lang.Integer" parameterType="java.util.HashMap" >
         select  count(*) from  video,course,speaker where video.speaker_id = speaker.id and video.course_id = course.id
            <if test="videoTitle!=null and videoTitle != '' ">
               and video_title like '%' #{videoTitle} '%'
            </if>
            <if test="speakerId != null and speakerId != ''">
                and speaker_id = #{speakerId}
            </if>
            <if test="courseId != null and courseId != ''">
                and course_id = #{courseId}
            </if>
    </select>
    <select id="queryVideosByCourseId" resultType="video">
        select * from video where course_id = #{courseId}
    </select>
    <select id="queryVideoByVideoId" resultMap="videoMap">
        select * from video,course,speaker where video.course_id = course.id and video.speaker_id = speaker.id  and video.id = #{videoId}
    </select>
    <select id="queryCourseByVideoId" resultType="Integer">
        select course_id from  video where id = #{videoId}
    </select>
    <!--查询视频的播放次数  科目表不需要
        video course
        平均播放次数
    -->
    <select id="queryVideoPlayTime" resultType="java.util.HashMap">
        select course_id,course_name,round(avg(video_play_times)) avgTimes from video v,course c where v.course_id = c.id
        group  by course_id, course_name
    </select>
    <select id="queryVideoPlayTimes" resultType="Integer">
        select  video_play_times from video where  id = #{id}
    </select>
    <update id="addVideoPlayTimes" parameterType="Integer">
        update video set  video_play_times = #{num} where id = #{id}
    </update>
</mapper>